<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>flaml.nlp.autotransformers &mdash; FLAML  documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> FLAML
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">FLAML</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>flaml.nlp.autotransformers</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for flaml.nlp.autotransformers</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">ray</span>
    <span class="kn">import</span> <span class="nn">transformers</span>
    <span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">TrainingArguments</span>
    <span class="kn">import</span> <span class="nn">datasets</span>
    <span class="kn">from</span> <span class="nn">.dataset.task_auto</span> <span class="kn">import</span> <span class="n">get_default_task</span>
    <span class="kn">from</span> <span class="nn">.result_analysis.azure_utils</span> <span class="kn">import</span> <span class="n">JobID</span>
    <span class="kn">from</span> <span class="nn">.huggingface.trainer</span> <span class="kn">import</span> <span class="n">TrainerForAutoTransformers</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;To use the nlp component in flaml, run pip install flaml[nlp]&quot;</span><span class="p">)</span>

<span class="n">task_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;seq-classification&quot;</span><span class="p">,</span>
    <span class="s2">&quot;regression&quot;</span><span class="p">,</span>
    <span class="s2">&quot;question-answering&quot;</span>
<span class="p">]</span>


<div class="viewcode-block" id="AutoTransformers"><a class="viewcode-back" href="../../../index.html#flaml.nlp.AutoTransformers">[docs]</a><span class="k">class</span> <span class="nc">AutoTransformers</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;The AutoTransformers class</span>

<span class="sd">    Example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            autohf = AutoTransformers()</span>
<span class="sd">            autohf_settings = {</span>
<span class="sd">                &quot;resources_per_trial&quot;: {&quot;cpu&quot;: 1, &quot;gpu&quot;: 1},</span>
<span class="sd">                &quot;num_samples&quot;: -1,</span>
<span class="sd">                &quot;time_budget&quot;: 60,</span>
<span class="sd">            }</span>

<span class="sd">            validation_metric, analysis = autohf.fit(**autohf_settings)</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_convert_dict_to_ray_tune_space</span><span class="p">(</span><span class="n">config_json</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;grid&quot;</span><span class="p">):</span>
        <span class="n">search_space</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;grid&quot;</span><span class="p">:</span>
            <span class="c1"># TODO add test</span>
            <span class="k">for</span> <span class="n">each_hp</span> <span class="ow">in</span> <span class="n">config_json</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">this_config</span> <span class="o">=</span> <span class="n">config_json</span><span class="p">[</span><span class="n">each_hp</span><span class="p">]</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">this_config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">this_config</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> \
                    <span class="s2">&quot;config of &quot;</span> <span class="o">+</span> <span class="n">each_hp</span> <span class="o">+</span> <span class="s2">&quot; must be dict or list for grid search&quot;</span>
                <span class="n">search_space</span><span class="p">[</span><span class="n">each_hp</span><span class="p">]</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">tune</span><span class="o">.</span><span class="n">grid_search</span><span class="p">(</span><span class="n">this_config</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">each_hp</span> <span class="ow">in</span> <span class="n">config_json</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">this_config</span> <span class="o">=</span> <span class="n">config_json</span><span class="p">[</span><span class="n">each_hp</span><span class="p">]</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">this_config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">this_config</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> \
                    <span class="s2">&quot;config of &quot;</span> <span class="o">+</span> <span class="n">each_hp</span> <span class="o">+</span> <span class="s2">&quot; must be dict or list&quot;</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">this_config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">lower</span> <span class="o">=</span> <span class="n">this_config</span><span class="p">[</span><span class="s2">&quot;l&quot;</span><span class="p">]</span>
                    <span class="n">upper</span> <span class="o">=</span> <span class="n">this_config</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">]</span>
                    <span class="n">space</span> <span class="o">=</span> <span class="n">this_config</span><span class="p">[</span><span class="s2">&quot;space&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">space</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
                        <span class="n">search_space</span><span class="p">[</span><span class="n">each_hp</span><span class="p">]</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">tune</span><span class="o">.</span><span class="n">loguniform</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">space</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
                        <span class="n">search_space</span><span class="p">[</span><span class="n">each_hp</span><span class="p">]</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">tune</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">space</span> <span class="o">==</span> <span class="s2">&quot;quniform&quot;</span><span class="p">:</span>
                        <span class="n">search_space</span><span class="p">[</span><span class="n">each_hp</span><span class="p">]</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">tune</span><span class="o">.</span><span class="n">quniform</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">this_config</span><span class="p">[</span><span class="s2">&quot;interval&quot;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">search_space</span><span class="p">[</span><span class="n">each_hp</span><span class="p">]</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">tune</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">this_config</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">search_space</span>

    <span class="k">def</span> <span class="nf">_set_search_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="o">**</span><span class="n">custom_hpo_args</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.hpo.hpo_searchspace</span> <span class="kn">import</span> <span class="n">AutoHPOSearchSpace</span>

        <span class="n">search_space_hpo_json</span> \
            <span class="o">=</span> <span class="n">AutoHPOSearchSpace</span><span class="o">.</span><span class="n">from_model_and_dataset_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">spa</span><span class="p">,</span>
                                                             <span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">pre</span><span class="p">,</span>
                                                             <span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">presz</span><span class="p">,</span>
                                                             <span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">dat</span><span class="p">,</span>
                                                             <span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">subdat</span><span class="p">,</span>
                                                             <span class="o">**</span><span class="n">custom_hpo_args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_search_space_hpo</span> <span class="o">=</span> <span class="n">AutoTransformers</span><span class="o">.</span><span class="n">_convert_dict_to_ray_tune_space</span><span class="p">(</span>
            <span class="n">search_space_hpo_json</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">mod</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_split_name</span><span class="p">(</span><span class="n">data_raw</span><span class="p">,</span> <span class="n">fold_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># TODO coverage</span>
        <span class="k">if</span> <span class="n">fold_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fold_name</span>
        <span class="n">fold_keys</span> <span class="o">=</span> <span class="n">data_raw</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">fold_keys</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;validation&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">}:</span>
            <span class="k">return</span> <span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;validation&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span>
        <span class="k">for</span> <span class="n">each_key</span> <span class="ow">in</span> <span class="n">fold_keys</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">each_split_name</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;validation&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">}:</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="n">each_key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">each_split_name</span><span class="p">)</span> <span class="ow">and</span> <span class="n">each_key</span> <span class="o">!=</span> <span class="n">each_split_name</span><span class="p">),</span> \
                    <span class="s2">&quot;Dataset split must be within </span><span class="si">{}</span><span class="s2">, must be explicitly specified in dataset_config, e.g.,&quot;</span> \
                    <span class="s2">&quot;&#39;fold_name&#39;: [&#39;train&#39;,&#39;validation_matched&#39;,&#39;test_matched&#39;]. Please refer to the example in the &quot;</span> \
                    <span class="s2">&quot;documentation of AutoTransformers.prepare_data()&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fold_keys</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;validation&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span>

<div class="viewcode-block" id="AutoTransformers.prepare_data"><a class="viewcode-back" href="../../../index.html#flaml.nlp.AutoTransformers.prepare_data">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                     <span class="n">data_root_path</span><span class="p">,</span>
                     <span class="n">jobid_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">is_wandb_on</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">server_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">max_seq_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
                     <span class="n">fold_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">resplit_portion</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="o">**</span><span class="n">custom_data_args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepare data</span>

<span class="sd">            Example:</span>

<span class="sd">                .. code-block:: python</span>

<span class="sd">                    preparedata_setting = {&quot;server_name&quot;: &quot;tmdev&quot;, &quot;data_root_path&quot;: &quot;data/&quot;, &quot;max_seq_length&quot;: 128,</span>
<span class="sd">                                               &quot;jobid_config&quot;: jobid_config, &quot;wandb_utils&quot;: wandb_utils,</span>
<span class="sd">                                               &quot;resplit_portion&quot;: {&quot;source&quot;: [&quot;train&quot;, &quot;validation&quot;],</span>
<span class="sd">                                               &quot;train&quot;: [0, 0.8], &quot;validation&quot;: [0.8, 0.9], &quot;test&quot;: [0.9, 1.0]}}</span>

<span class="sd">                    autohf.prepare_data(**preparedata_setting)</span>

<span class="sd">            Args:</span>
<span class="sd">                server_name:</span>
<span class="sd">                    A string variable, which can be tmdev or azureml</span>
<span class="sd">                data_root_path:</span>
<span class="sd">                    The root path for storing the checkpoints and output results, e.g., &quot;data/&quot;</span>
<span class="sd">                jobid_config:</span>
<span class="sd">                    A JobID object describing the profile of job</span>
<span class="sd">                wandb_utils:</span>
<span class="sd">                    A WandbUtils object for wandb operations</span>
<span class="sd">                max_seq_length (optional):</span>
<span class="sd">                    Max_seq_lckpt_per_epochength for the huggingface, this hyperparameter must be specified</span>
<span class="sd">                    at the data processing step</span>
<span class="sd">                resplit_portion:</span>
<span class="sd">                    The proportion for resplitting the train and dev data when split_mode=&quot;resplit&quot;.</span>
<span class="sd">                    If args.resplit_mode = &quot;rspt&quot;, resplit_portion is required</span>
<span class="sd">                is_wandb_on:</span>
<span class="sd">                    A boolean variable indicating whether wandb is used</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.dataset.dataprocess_auto</span> <span class="kn">import</span> <span class="n">AutoEncodeText</span>
        <span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoTokenizer</span>
        <span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">load_dataset</span>
        <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">PathUtils</span>
        <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">load_dft_args</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_max_seq_length</span> <span class="o">=</span> <span class="n">max_seq_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server_name</span> <span class="o">=</span> <span class="n">server_name</span> <span class="k">if</span> <span class="n">server_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;tmdev&quot;</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            loading the jobid config from console args</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">console_args</span> <span class="o">=</span> <span class="n">load_dft_args</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span> <span class="o">=</span> <span class="n">JobID</span><span class="p">(</span><span class="n">console_args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">jobid_config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span> <span class="o">=</span> <span class="n">jobid_config</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">custom_data_args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">set_jobid_from_console_args</span><span class="p">(</span><span class="n">console_args</span><span class="o">=</span><span class="n">custom_data_args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_wandb_on</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.result_analysis.wandb_utils</span> <span class="kn">import</span> <span class="n">WandbUtils</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wandb_utils</span> <span class="o">=</span> <span class="n">WandbUtils</span><span class="p">(</span><span class="n">is_wandb_on</span><span class="o">=</span><span class="n">is_wandb_on</span><span class="p">,</span>
                                          <span class="n">wandb_key_path</span><span class="o">=</span><span class="n">console_args</span><span class="o">.</span><span class="n">key_path</span><span class="p">,</span>
                                          <span class="n">jobid_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wandb_utils</span><span class="o">.</span><span class="n">set_wandb_per_run</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wandb_utils</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">path_utils</span> <span class="o">=</span> <span class="n">PathUtils</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="p">,</span> <span class="n">hpo_data_root_path</span><span class="o">=</span><span class="n">data_root_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">spt</span> <span class="o">==</span> <span class="s2">&quot;rspt&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">resplit_portion</span><span class="p">,</span> <span class="s2">&quot;If split mode is &#39;rspt&#39;, the resplit_portion must be provided. Please &quot;</span> \
                                    <span class="s2">&quot;refer to the example in the documentation of AutoTransformers.prepare_data()&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">subdat</span><span class="p">:</span>
            <span class="n">data_raw</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">JobID</span><span class="o">.</span><span class="n">dataset_list_to_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">dat</span><span class="p">),</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">subdat</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_raw</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">dat</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_train_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dev_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_name</span> <span class="o">=</span> <span class="n">AutoTransformers</span><span class="o">.</span><span class="n">_get_split_name</span><span class="p">(</span>
            <span class="n">data_raw</span><span class="p">,</span>
            <span class="n">fold_name</span><span class="o">=</span><span class="n">fold_name</span><span class="p">)</span>
        <span class="n">auto_tokentoids_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;max_seq_length&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_seq_length</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">pre_full</span><span class="p">,</span> <span class="n">use_fast</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">autoencodetext_from_model_and_dataset_name</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">AutoEncodeText</span><span class="o">.</span><span class="n">from_model_and_dataset_name</span><span class="p">(</span>
                <span class="n">data_raw</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">pre_full</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">dat</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">subdat</span><span class="p">,</span>
                <span class="o">**</span><span class="n">auto_tokentoids_config</span><span class="p">)</span>

        <span class="n">data_encoded</span> <span class="o">=</span> <span class="n">autoencodetext_from_model_and_dataset_name</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_seq_length</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Update the max_seq_length to the minimum of the actual max seq length and the user defined max_seq_length</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">each_fold</span> <span class="ow">in</span> <span class="n">data_encoded</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_max_seq_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_seq_length</span><span class="p">,</span>
                                       <span class="nb">max</span><span class="p">([</span><span class="nb">sum</span><span class="p">(</span><span class="n">data_encoded</span><span class="p">[</span><span class="n">each_fold</span><span class="p">][</span><span class="n">x</span><span class="p">][</span><span class="s1">&#39;attention_mask&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                                            <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_encoded</span><span class="p">[</span><span class="n">each_fold</span><span class="p">]))]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_seq_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_seq_length</span> <span class="o">+</span> <span class="mi">15</span><span class="p">)</span> <span class="o">/</span> <span class="mi">16</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span>
        <span class="n">data_encoded</span> <span class="o">=</span> <span class="n">autoencodetext_from_model_and_dataset_name</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">spt</span> <span class="o">==</span> <span class="s2">&quot;rspt&quot;</span><span class="p">:</span>
            <span class="n">all_folds_from_source</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">assert</span> <span class="s2">&quot;source&quot;</span> <span class="ow">in</span> <span class="n">resplit_portion</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="s2">&quot;Must specify the source for resplitting the dataset in&quot;</span> \
                                                       <span class="s2">&quot;resplit_portion, which is a list of folder names, e.g., &quot;</span> \
                                                       <span class="s2">&quot;resplit_portion = {&#39;source&#39;: [&#39;train&#39;]}&quot;</span>

            <span class="n">source_fold_names</span> <span class="o">=</span> <span class="n">resplit_portion</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">each_fold_name</span> <span class="ow">in</span> <span class="n">source_fold_names</span><span class="p">:</span>
                <span class="n">this_fold_dataset</span> <span class="o">=</span> <span class="n">data_encoded</span><span class="p">[</span><span class="n">each_fold_name</span><span class="p">]</span>
                <span class="n">all_folds_from_source</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_fold_dataset</span><span class="p">)</span>

            <span class="n">merged_folds_from_source</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">concatenate_datasets</span><span class="p">(</span><span class="n">all_folds_from_source</span><span class="p">)</span>
            <span class="n">merged_folds_from_source</span> <span class="o">=</span> <span class="n">merged_folds_from_source</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">sddt</span><span class="p">)</span>

            <span class="k">assert</span> <span class="s2">&quot;train&quot;</span> <span class="ow">in</span> <span class="n">resplit_portion</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s2">&quot;validation&quot;</span> <span class="ow">in</span> <span class="n">resplit_portion</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> \
                   <span class="ow">and</span> <span class="s2">&quot;test&quot;</span> <span class="ow">in</span> <span class="n">resplit_portion</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="s2">&quot;train, validation, test must exist in resplit_portion&quot;</span>

            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;validation&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]:</span>
                <span class="n">target_fold_start</span><span class="p">,</span> <span class="n">target_fold_end</span> <span class="o">=</span> \
                    <span class="nb">int</span><span class="p">(</span><span class="n">resplit_portion</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged_folds_from_source</span><span class="p">)),</span> \
                    <span class="nb">int</span><span class="p">(</span><span class="n">resplit_portion</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged_folds_from_source</span><span class="p">))</span>
                <span class="n">subfold_dataset</span> <span class="o">=</span> <span class="n">merged_folds_from_source</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">target_fold_start</span><span class="p">,</span> <span class="n">target_fold_end</span><span class="p">)])</span><span class="o">.</span><span class="n">flatten_indices</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span> <span class="o">=</span> <span class="n">subfold_dataset</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;validation&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">subfold_dataset</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">test_dataset</span> <span class="o">=</span> <span class="n">subfold_dataset</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_dataset</span> \
                <span class="o">=</span> <span class="n">data_encoded</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_train_name</span><span class="p">],</span> <span class="n">data_encoded</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dev_name</span><span class="p">],</span> <span class="n">data_encoded</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_name</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">_load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">checkpoint_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">per_model_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoConfig</span>
        <span class="kn">from</span> <span class="nn">.huggingface.switch_head_auto</span> <span class="kn">import</span> <span class="n">AutoSeqClassificationHead</span><span class="p">,</span> <span class="n">MODEL_CLASSIFICATION_HEAD_MAPPING</span>

        <span class="n">this_task</span> <span class="o">=</span> <span class="n">get_default_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">dat</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">subdat</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">this_task</span> <span class="o">==</span> <span class="s2">&quot;seq-classification&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_num_labels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">this_task</span> <span class="o">==</span> <span class="s2">&quot;regression&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_num_labels</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">checkpoint_path</span><span class="p">:</span>
            <span class="n">checkpoint_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">pre_full</span>

        <span class="k">def</span> <span class="nf">get_this_model</span><span class="p">():</span>
            <span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoModelForSequenceClassification</span>
            <span class="k">return</span> <span class="n">AutoModelForSequenceClassification</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">model_config</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">is_pretrained_model_in_classification_head_list</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">pre</span> <span class="ow">in</span> <span class="n">MODEL_CLASSIFICATION_HEAD_MAPPING</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">_set_model_config</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">per_model_config</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">per_model_config</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">model_config</span> <span class="o">=</span> <span class="n">AutoConfig</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
                    <span class="n">checkpoint_path</span><span class="p">,</span>
                    <span class="n">num_labels</span><span class="o">=</span><span class="n">model_config_num_labels</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">per_model_config</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">model_config</span> <span class="o">=</span> <span class="n">AutoConfig</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
                    <span class="n">checkpoint_path</span><span class="p">,</span>
                    <span class="n">num_labels</span><span class="o">=</span><span class="n">model_config_num_labels</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">model_config</span>

        <span class="k">if</span> <span class="n">this_task</span> <span class="o">==</span> <span class="s2">&quot;seq-classification&quot;</span><span class="p">:</span>
            <span class="n">num_labels_old</span> <span class="o">=</span> <span class="n">AutoConfig</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">)</span><span class="o">.</span><span class="n">num_labels</span>
            <span class="k">if</span> <span class="n">is_pretrained_model_in_classification_head_list</span><span class="p">():</span>
                <span class="n">model_config_num_labels</span> <span class="o">=</span> <span class="n">num_labels_old</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">model_config_num_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_labels</span>
            <span class="n">model_config</span> <span class="o">=</span> <span class="n">_set_model_config</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">is_pretrained_model_in_classification_head_list</span><span class="p">():</span>
                <span class="c1"># TODO coverage</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_labels</span> <span class="o">!=</span> <span class="n">num_labels_old</span><span class="p">:</span>
                    <span class="n">this_model</span> <span class="o">=</span> <span class="n">get_this_model</span><span class="p">()</span>
                    <span class="n">model_config</span><span class="o">.</span><span class="n">num_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_labels</span>
                    <span class="n">this_model</span><span class="o">.</span><span class="n">num_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_labels</span>
                    <span class="n">this_model</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">AutoSeqClassificationHead</span> \
                        <span class="o">.</span><span class="n">from_model_type_and_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">pre</span><span class="p">,</span>
                                                    <span class="n">model_config</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">this_model</span> <span class="o">=</span> <span class="n">get_this_model</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">this_model</span> <span class="o">=</span> <span class="n">get_this_model</span><span class="p">()</span>

            <span class="n">this_model</span><span class="o">.</span><span class="n">resize_token_embeddings</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tokenizer</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">this_model</span>
        <span class="k">elif</span> <span class="n">this_task</span> <span class="o">==</span> <span class="s2">&quot;regression&quot;</span><span class="p">:</span>
            <span class="c1"># TODO add test</span>
            <span class="n">model_config_num_labels</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">model_config</span> <span class="o">=</span> <span class="n">_set_model_config</span><span class="p">()</span>
            <span class="n">this_model</span> <span class="o">=</span> <span class="n">get_this_model</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">this_model</span>

    <span class="k">def</span> <span class="nf">_get_metric_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data_name</span> <span class="o">=</span> <span class="n">JobID</span><span class="o">.</span><span class="n">dataset_list_to_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">dat</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;glue&quot;</span><span class="p">,</span> <span class="s2">&quot;super_glue&quot;</span><span class="p">):</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">load</span><span class="o">.</span><span class="n">load_metric</span><span class="p">(</span><span class="n">data_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">subdat</span><span class="p">)</span>
        <span class="c1"># TODO delete</span>
        <span class="k">elif</span> <span class="n">data_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;squad&quot;</span><span class="p">,</span> <span class="s2">&quot;squad_v2&quot;</span><span class="p">):</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">load</span><span class="o">.</span><span class="n">load_metric</span><span class="p">(</span><span class="n">data_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">load</span><span class="o">.</span><span class="n">load_metric</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">metric</span>

    <span class="k">def</span> <span class="nf">_compute_metrics_by_dataset_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                         <span class="n">eval_pred</span><span class="p">):</span>
        <span class="c1"># TODO coverage</span>
        <span class="n">predictions</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">eval_pred</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span> \
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_name</span> <span class="o">==</span> <span class="s2">&quot;regression&quot;</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">metric_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_metric_func</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">metric_func</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">predictions</span><span class="o">=</span><span class="n">predictions</span><span class="p">,</span> <span class="n">references</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute_checkpoint_freq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                 <span class="n">num_train_epochs</span><span class="p">,</span>
                                 <span class="n">batch_size</span><span class="p">):</span>
        <span class="c1"># TODO coverage</span>
        <span class="k">if</span> <span class="s2">&quot;gpu&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resources_per_trial</span><span class="p">:</span>
            <span class="n">ckpt_step_freq</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">num_train_epochs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">)</span> <span class="o">/</span> <span class="n">batch_size</span>
                                 <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resources_per_trial</span><span class="p">[</span><span class="s2">&quot;gpu&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ckpt_per_epoch</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ckpt_step_freq</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">num_train_epochs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">)</span> <span class="o">/</span> <span class="n">batch_size</span>
                                 <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resources_per_trial</span><span class="p">[</span><span class="s2">&quot;cpu&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ckpt_per_epoch</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">ckpt_step_freq</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_separate_config</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>

        <span class="n">training_args_config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">per_model_config</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">TrainingArguments</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">training_args_config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">per_model_config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">training_args_config</span><span class="p">,</span> <span class="n">per_model_config</span>

    <span class="k">def</span> <span class="nf">_objective</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">reporter</span><span class="p">,</span> <span class="n">checkpoint_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># TODO add test</span>
        <span class="kn">from</span> <span class="nn">transformers.trainer_utils</span> <span class="kn">import</span> <span class="n">set_seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_transformers_verbosity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transformers_verbose</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">model_init</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_model</span><span class="p">()</span>
        <span class="n">set_seed</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;seed&quot;</span><span class="p">])</span>

        <span class="n">training_args_config</span><span class="p">,</span> <span class="n">per_model_config</span> <span class="o">=</span> <span class="n">AutoTransformers</span><span class="o">.</span><span class="n">_separate_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="n">this_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_model</span><span class="p">(</span><span class="n">per_model_config</span><span class="o">=</span><span class="n">per_model_config</span><span class="p">)</span>

        <span class="n">trial_id</span> <span class="o">=</span> <span class="n">reporter</span><span class="o">.</span><span class="n">trial_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_utils</span><span class="o">.</span><span class="n">make_dir_per_trial</span><span class="p">(</span><span class="n">trial_id</span><span class="p">)</span>

        <span class="n">ckpt_freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_checkpoint_freq</span><span class="p">(</span>
            <span class="n">num_train_epochs</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;num_train_epochs&quot;</span><span class="p">],</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;per_device_train_batch_size&quot;</span><span class="p">])</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_utils</span><span class="o">.</span><span class="n">ckpt_dir_per_trial</span>

        <span class="k">if</span> <span class="n">transformers</span><span class="o">.</span><span class="n">__version__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;3&quot;</span><span class="p">):</span>
            <span class="n">training_args</span> <span class="o">=</span> <span class="n">TrainingArguments</span><span class="p">(</span>
                <span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path_utils</span><span class="o">.</span><span class="n">ckpt_dir_per_trial</span><span class="p">,</span>
                <span class="n">do_eval</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">per_device_eval_batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                <span class="n">eval_steps</span><span class="o">=</span><span class="n">ckpt_freq</span><span class="p">,</span>
                <span class="n">evaluate_during_training</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">save_steps</span><span class="o">=</span><span class="n">ckpt_freq</span><span class="p">,</span>
                <span class="n">save_total_limit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">fp16</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fp16</span><span class="p">,</span>
                <span class="o">**</span><span class="n">training_args_config</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">IntervalStrategy</span>
            <span class="n">training_args</span> <span class="o">=</span> <span class="n">TrainingArguments</span><span class="p">(</span>
                <span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path_utils</span><span class="o">.</span><span class="n">ckpt_dir_per_trial</span><span class="p">,</span>
                <span class="n">do_eval</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">per_device_eval_batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                <span class="n">eval_steps</span><span class="o">=</span><span class="n">ckpt_freq</span><span class="p">,</span>
                <span class="n">evaluation_strategy</span><span class="o">=</span><span class="n">IntervalStrategy</span><span class="o">.</span><span class="n">STEPS</span><span class="p">,</span>
                <span class="n">save_steps</span><span class="o">=</span><span class="n">ckpt_freq</span><span class="p">,</span>
                <span class="n">save_total_limit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">fp16</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fp16</span><span class="p">,</span>
                <span class="o">**</span><span class="n">training_args_config</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">trainer</span> <span class="o">=</span> <span class="n">TrainerForAutoTransformers</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">this_model</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="n">training_args</span><span class="p">,</span>
            <span class="n">model_init</span><span class="o">=</span><span class="n">model_init</span><span class="p">,</span>
            <span class="n">train_dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span>
            <span class="n">eval_dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tokenizer</span><span class="p">,</span>
            <span class="n">compute_metrics</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_compute_metrics_by_dataset_name</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">trainer</span><span class="o">.</span><span class="n">trial_id</span> <span class="o">=</span> <span class="n">reporter</span><span class="o">.</span><span class="n">trial_id</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            create a wandb run. If os.environ[&quot;WANDB_MODE&quot;] == &quot;offline&quot;, run = None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wandb_utils</span><span class="p">:</span>
            <span class="n">run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wandb_utils</span><span class="o">.</span><span class="n">set_wandb_per_trial</span><span class="p">()</span>
            <span class="kn">import</span> <span class="nn">wandb</span>
            <span class="k">for</span> <span class="n">each_hp</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                <span class="n">wandb</span><span class="o">.</span><span class="n">log</span><span class="p">({</span><span class="n">each_hp</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="n">each_hp</span><span class="p">]})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">run</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="n">trainer</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            If a wandb run was created, close the run after train and evaluate finish</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">run</span><span class="p">:</span>
            <span class="n">run</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_verify_init_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="o">**</span><span class="n">custom_hpo_args</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">custom_hpo_args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;points_to_evaluate&quot;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">each_init_config</span> <span class="ow">in</span> <span class="n">custom_hpo_args</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">each_hp</span> <span class="ow">in</span> <span class="n">each_init_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">assert</span> <span class="n">each_hp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_space_hpo</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> \
                            <span class="s2">&quot;points_to_evaluate hp must be within the search space&quot;</span>

                        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">each_init_config</span><span class="p">[</span><span class="n">each_hp</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> \
                               <span class="nb">isinstance</span><span class="p">(</span><span class="n">each_init_config</span><span class="p">[</span><span class="n">each_hp</span><span class="p">],</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> \
                               <span class="nb">isinstance</span><span class="p">(</span><span class="n">each_init_config</span><span class="p">[</span><span class="n">each_hp</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> \
                               <span class="nb">isinstance</span><span class="p">(</span><span class="n">each_init_config</span><span class="p">[</span><span class="n">each_hp</span><span class="p">],</span> <span class="nb">bool</span><span class="p">),</span> <span class="s2">&quot; points_to_evaluate must be a scalar&quot;</span>

                        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_search_space_hpo</span><span class="p">[</span><span class="n">each_hp</span><span class="p">],</span> <span class="n">ray</span><span class="o">.</span><span class="n">tune</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">Categorical</span><span class="p">)</span> <span class="ow">or</span> \
                               <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_search_space_hpo</span><span class="p">[</span><span class="n">each_hp</span><span class="p">],</span> <span class="n">ray</span><span class="o">.</span><span class="n">tune</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">Float</span><span class="p">)</span> <span class="ow">or</span> \
                               <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_search_space_hpo</span><span class="p">[</span><span class="n">each_hp</span><span class="p">],</span> <span class="n">ray</span><span class="o">.</span><span class="n">tune</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">Integer</span><span class="p">),</span> \
                               <span class="s2">&quot;Every hp space must either be categorical, integer or float&quot;</span>

                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_search_space_hpo</span><span class="p">[</span><span class="n">each_hp</span><span class="p">],</span> <span class="n">ray</span><span class="o">.</span><span class="n">tune</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">Categorical</span><span class="p">):</span>
                            <span class="k">assert</span> <span class="n">each_init_config</span><span class="p">[</span><span class="n">each_hp</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_space_hpo</span><span class="p">[</span><span class="n">each_hp</span><span class="p">]</span><span class="o">.</span><span class="n">categories</span><span class="p">,</span> \
                                <span class="s2">&quot;points_to_evaluate </span><span class="si">{each_hp}</span><span class="s2"> value must be within the search space&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_space_hpo</span><span class="p">[</span><span class="n">each_hp</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span> <span class="o">&lt;=</span> <span class="n">each_init_config</span><span class="p">[</span><span class="n">each_hp</span><span class="p">]</span> <span class="o">&lt;=</span> \
                                   <span class="bp">self</span><span class="o">.</span><span class="n">_search_space_hpo</span><span class="p">[</span><span class="n">each_hp</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> \
                                   <span class="s2">&quot;points_to_evaluate </span><span class="si">{each_hp}</span><span class="s2"> value must be within the search space&quot;</span>

    <span class="k">def</span> <span class="nf">_get_search_algo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                         <span class="n">search_algo_name</span><span class="p">,</span>
                         <span class="n">search_algo_args_mode</span><span class="p">,</span>
                         <span class="n">time_budget</span><span class="p">,</span>
                         <span class="n">metric_name</span><span class="p">,</span>
                         <span class="n">metric_mode_name</span><span class="p">,</span>
                         <span class="o">**</span><span class="n">custom_hpo_args</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.hpo.searchalgo_auto</span> <span class="kn">import</span> <span class="n">AutoSearchAlgorithm</span>

        <span class="k">if</span> <span class="n">search_algo_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;bs&quot;</span><span class="p">,</span> <span class="s2">&quot;cfo&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_verify_init_config</span><span class="p">(</span><span class="o">**</span><span class="n">custom_hpo_args</span><span class="p">)</span>
        <span class="n">search_algo</span> <span class="o">=</span> <span class="n">AutoSearchAlgorithm</span><span class="o">.</span><span class="n">from_method_name</span><span class="p">(</span>
            <span class="n">search_algo_name</span><span class="p">,</span>
            <span class="n">search_algo_args_mode</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_search_space_hpo</span><span class="p">,</span>
            <span class="n">time_budget</span><span class="p">,</span>
            <span class="n">metric_name</span><span class="p">,</span>
            <span class="n">metric_mode_name</span><span class="p">,</span>
            <span class="o">**</span><span class="n">custom_hpo_args</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">search_algo</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_recover_checkpoint</span><span class="p">(</span><span class="n">tune_checkpoint_dir</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">tune_checkpoint_dir</span>
        <span class="c1"># Get subdirectory used for Huggingface.</span>
        <span class="n">subdirs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tune_checkpoint_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">tune_checkpoint_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tune_checkpoint_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
        <span class="p">]</span>
        <span class="c1"># There should only be 1 subdir.</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">subdirs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">subdirs</span>
        <span class="k">return</span> <span class="n">subdirs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_save_ckpt_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">best_ckpt</span><span class="p">):</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">({</span><span class="s2">&quot;best_ckpt&quot;</span><span class="p">:</span> <span class="n">best_ckpt</span><span class="p">},</span>
                  <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_utils</span><span class="o">.</span><span class="n">result_dir_per_run</span><span class="p">,</span>
                                    <span class="s2">&quot;save_ckpt_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">to_jobid_string</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_save_output_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="n">output_metrics</span><span class="p">):</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">output_metrics</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_utils</span><span class="o">.</span><span class="n">result_dir_per_run</span><span class="p">,</span>
                         <span class="s2">&quot;output_metric_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">to_jobid_string</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_load_ckpt_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">ckpt_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ckpt_dir</span><span class="p">:</span>
            <span class="n">ckpt_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_utils</span><span class="o">.</span><span class="n">result_dir_per_run</span><span class="p">,</span>
                                    <span class="s2">&quot;save_ckpt_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">to_jobid_string</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ckpt_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">ckpt_dir</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">ckpt_json</span><span class="p">[</span><span class="s2">&quot;best_ckpt&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saved checkpoint not found. Please make sure checkpoint is stored under </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ckpt_dir</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">_set_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_metric_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">custom_metric_mode_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.dataset.metric_auto</span> <span class="kn">import</span> <span class="n">get_default_and_alternative_metric</span>
        <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">_variable_override_default_alternative</span>

        <span class="n">default_metric</span><span class="p">,</span> <span class="n">default_mode</span><span class="p">,</span> <span class="n">all_metrics</span><span class="p">,</span> <span class="n">all_modes</span> <span class="o">=</span> \
            <span class="n">get_default_and_alternative_metric</span><span class="p">(</span>
                <span class="n">dataset_name_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">dat</span><span class="p">,</span>
                <span class="n">subdataset_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">subdat</span><span class="p">,</span>
                <span class="n">custom_metric_name</span><span class="o">=</span><span class="n">custom_metric_name</span><span class="p">,</span>
                <span class="n">custom_metric_mode_name</span><span class="o">=</span><span class="n">custom_metric_mode_name</span><span class="p">)</span>
        <span class="n">_variable_override_default_alternative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                               <span class="s2">&quot;metric_name&quot;</span><span class="p">,</span>
                                               <span class="n">default_metric</span><span class="p">,</span>
                                               <span class="n">all_metrics</span><span class="p">,</span>
                                               <span class="n">custom_metric_name</span><span class="p">)</span>
        <span class="n">_variable_override_default_alternative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                               <span class="s2">&quot;metric_mode_name&quot;</span><span class="p">,</span>
                                               <span class="n">default_mode</span><span class="p">,</span>
                                               <span class="n">all_modes</span><span class="p">,</span>
                                               <span class="n">custom_metric_mode_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_metrics</span> <span class="o">=</span> <span class="n">all_metrics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_modes</span> <span class="o">=</span> <span class="n">all_modes</span>

    <span class="k">def</span> <span class="nf">_set_task</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_name</span> <span class="o">=</span> <span class="n">get_default_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">dat</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">subdat</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fit_hf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
               <span class="n">resources_per_trial</span><span class="p">,</span>
               <span class="n">num_samples</span><span class="p">,</span>
               <span class="n">time_budget</span><span class="p">,</span>
               <span class="n">custom_metric_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">custom_metric_mode_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">_fp16</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
               <span class="o">**</span><span class="n">custom_hpo_args</span>
               <span class="p">):</span>
        <span class="c1"># TODO remove?</span>
        <span class="kn">from</span> <span class="nn">transformers.trainer_utils</span> <span class="kn">import</span> <span class="n">HPSearchBackend</span>

        <span class="sd">&#39;&#39;&#39;Fine tuning the huggingface using HF&#39;s API Transformers.hyperparameter_search (for comparitive purpose).</span>
<span class="sd">               Transformers.hyperparameter_search has the following disadvantages:</span>
<span class="sd">            (1) it does not return tune.analysis.Analysis result, what is analysis used for</span>
<span class="sd">            (2) it is inconvenient to develop on top of Transformers.hyperparameter_search, whose trainable function,</span>
<span class="sd">                 search space, etc. are defined inside of Transformers.hyperparameter_search.</span>
<span class="sd">               An example:</span>
<span class="sd">            autohf_settings = {&quot;resources_per_trial&quot;: {&quot;cpu&quot;: 1},</span>
<span class="sd">                       &quot;num_samples&quot;: 1,</span>
<span class="sd">                       &quot;time_budget&quot;: 100000,</span>
<span class="sd">                       &quot;ckpt_per_epoch&quot;: 1,</span>
<span class="sd">                       &quot;fp16&quot;: False,</span>
<span class="sd">                      }</span>
<span class="sd">            validation_metric, analysis = autohf.fit(**autohf_settings,)</span>
<span class="sd">            Args:</span>
<span class="sd">                resources_per_trial:</span>
<span class="sd">                    A dict showing the resources used by each trial,</span>
<span class="sd">                    e.g., {&quot;gpu&quot;: 4, &quot;cpu&quot;: 4}</span>
<span class="sd">                num_samples:</span>
<span class="sd">                    An int variable of the maximum number of trials</span>
<span class="sd">                time_budget:</span>
<span class="sd">                    An int variable of the maximum time budget</span>
<span class="sd">                custom_metric_name:</span>
<span class="sd">                    A string of the dataset name or a function,</span>
<span class="sd">                    e.g., &#39;accuracy&#39;, &#39;f1&#39;, &#39;loss&#39;,</span>
<span class="sd">                custom_metric_mode_name:</span>
<span class="sd">                    A string of the mode name,</span>
<span class="sd">                    e.g., &quot;max&quot;, &quot;min&quot;, &quot;last&quot;, &quot;all&quot;</span>
<span class="sd">                fp16:</span>
<span class="sd">                    boolean, default = True | whether to use fp16</span>
<span class="sd">                custom_hpo_args:</span>
<span class="sd">                    The additional keyword arguments, e.g.,</span>
<span class="sd">                    custom_hpo_args = {&quot;points_to_evaluate&quot;: [{</span>
<span class="sd">                               &quot;num_train_epochs&quot;: 1,</span>
<span class="sd">                               &quot;per_device_train_batch_size&quot;: 128, }]}</span>
<span class="sd">            Returns:</span>
<span class="sd">               validation_metric:</span>
<span class="sd">                    a dict storing the validation score</span>
<span class="sd">            &#39;&#39;&#39;</span>

        <span class="k">def</span> <span class="nf">model_init</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_model</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">ray_hp_space</span><span class="p">(</span><span class="n">trial</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;learning_rate&quot;</span><span class="p">:</span> <span class="n">ray</span><span class="o">.</span><span class="n">tune</span><span class="o">.</span><span class="n">loguniform</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">),</span>
                <span class="s2">&quot;num_train_epochs&quot;</span><span class="p">:</span> <span class="n">ray</span><span class="o">.</span><span class="n">tune</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">))),</span>
                <span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="n">ray</span><span class="o">.</span><span class="n">tune</span><span class="o">.</span><span class="n">quniform</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="s2">&quot;per_device_train_batch_size&quot;</span><span class="p">:</span> <span class="n">ray</span><span class="o">.</span><span class="n">tune</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">]),</span>
            <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_metric</span><span class="p">(</span><span class="n">custom_metric_name</span><span class="p">,</span> <span class="n">custom_metric_mode_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_task</span><span class="p">()</span>

        <span class="n">training_args</span> <span class="o">=</span> <span class="n">TrainingArguments</span><span class="p">(</span>
            <span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path_utils</span><span class="o">.</span><span class="n">hpo_ckpt_path</span><span class="p">,</span>
            <span class="n">fp16</span><span class="o">=</span><span class="n">_fp16</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">this_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_model</span><span class="p">()</span>

        <span class="n">trainer</span> <span class="o">=</span> <span class="n">TrainerForAutoTransformers</span><span class="p">(</span>
            <span class="n">this_model</span><span class="p">,</span>
            <span class="n">training_args</span><span class="p">,</span>
            <span class="n">model_init</span><span class="o">=</span><span class="n">model_init</span><span class="p">,</span>
            <span class="n">train_dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span>
            <span class="n">eval_dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tokenizer</span><span class="p">,</span>
            <span class="n">compute_metrics</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_compute_metrics_by_dataset_name</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_utils</span><span class="o">.</span><span class="n">make_dir_per_run</span><span class="p">()</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">best_run</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">hyperparameter_search</span><span class="p">(</span>
            <span class="n">n_trials</span><span class="o">=</span><span class="n">num_samples</span><span class="p">,</span>
            <span class="n">time_budget_s</span><span class="o">=</span><span class="n">time_budget</span><span class="p">,</span>
            <span class="c1"># hp_space=ray_hp_space,</span>
            <span class="n">backend</span><span class="o">=</span><span class="n">HPSearchBackend</span><span class="o">.</span><span class="n">RAY</span><span class="p">,</span>
            <span class="n">resources_per_trial</span><span class="o">=</span><span class="n">resources_per_trial</span><span class="p">)</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_run_duration</span> <span class="o">=</span> <span class="n">duration</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total running time: </span><span class="si">{}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">duration</span><span class="p">))</span>

        <span class="n">hp_dict</span> <span class="o">=</span> <span class="n">best_run</span><span class="o">.</span><span class="n">hyperparameters</span>
        <span class="n">hp_dict</span><span class="p">[</span><span class="s2">&quot;seed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hp_dict</span><span class="p">[</span><span class="s2">&quot;seed&quot;</span><span class="p">])</span>

        <span class="n">best_training_args</span> <span class="o">=</span> <span class="n">TrainingArguments</span><span class="p">(</span>
            <span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path_utils</span><span class="o">.</span><span class="n">hpo_ckpt_path</span><span class="p">,</span>
            <span class="n">fp16</span><span class="o">=</span><span class="n">_fp16</span><span class="p">,</span>
            <span class="o">**</span><span class="n">hp_dict</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">best_trainer</span> <span class="o">=</span> <span class="n">TrainerForAutoTransformers</span><span class="p">(</span>
            <span class="n">this_model</span><span class="p">,</span>
            <span class="n">best_training_args</span><span class="p">,</span>
            <span class="n">model_init</span><span class="o">=</span><span class="n">model_init</span><span class="p">,</span>
            <span class="n">train_dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span>
            <span class="n">eval_dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tokenizer</span><span class="p">,</span>
            <span class="n">compute_metrics</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_compute_metrics_by_dataset_name</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">best_model_checkpoint_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_utils</span><span class="o">.</span><span class="n">hpo_ckpt_path</span><span class="p">,</span> <span class="s2">&quot;hpo_hf&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">best_model_checkpoint_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">best_model_checkpoint_path</span><span class="p">)</span>
        <span class="n">best_trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="n">best_trainer</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">best_model_checkpoint_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_ckpt_json</span><span class="p">(</span><span class="n">best_model_checkpoint_path</span><span class="p">)</span>
        <span class="n">validation_metric</span> <span class="o">=</span> <span class="n">best_trainer</span><span class="o">.</span><span class="n">evaluate</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">validation_metric</span>

    <span class="k">def</span> <span class="nf">_set_transformers_verbosity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transformers_verbose</span><span class="p">):</span>
        <span class="c1"># TODO coverage</span>
        <span class="k">if</span> <span class="n">transformers_verbose</span> <span class="o">==</span> <span class="n">transformers</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">:</span>
            <span class="n">transformers</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity_error</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">transformers_verbose</span> <span class="o">==</span> <span class="n">transformers</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">:</span>
            <span class="n">transformers</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity_warning</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">transformers_verbose</span> <span class="o">==</span> <span class="n">transformers</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">:</span>
            <span class="n">transformers</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity_info</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">transformers_verbose</span> <span class="o">==</span> <span class="n">transformers</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
            <span class="n">transformers</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity_debug</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;transformers_verbose must be set to ERROR, WARNING, INFO or DEBUG&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="AutoTransformers.fit"><a class="viewcode-back" href="../../../index.html#flaml.nlp.AutoTransformers.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">num_samples</span><span class="p">,</span>
            <span class="n">time_budget</span><span class="p">,</span>
            <span class="n">custom_metric_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">custom_metric_mode_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">ckpt_per_epoch</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">fp16</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">ray_verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">transformers_verbose</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">resources_per_trial</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">ray_local_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="o">**</span><span class="n">custom_hpo_args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fine tuning the huggingface using the hpo setting</span>

<span class="sd">        Example:</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                autohf_settings = {&quot;resources_per_trial&quot;: {&quot;cpu&quot;: 1},</span>
<span class="sd">                           &quot;num_samples&quot;: 1,</span>
<span class="sd">                           &quot;time_budget&quot;: 100000,</span>
<span class="sd">                           &quot;ckpt_per_epoch&quot;: 1,</span>
<span class="sd">                           &quot;fp16&quot;: False,</span>
<span class="sd">                          }</span>

<span class="sd">                validation_metric, analysis = autohf.fit(**autohf_settings)</span>

<span class="sd">        Args:</span>
<span class="sd">            resources_per_trial:</span>
<span class="sd">                A dict showing the resources used by each trial,</span>
<span class="sd">                e.g., {&quot;gpu&quot;: 4, &quot;cpu&quot;: 4}</span>
<span class="sd">            num_samples:</span>
<span class="sd">                An int variable of the maximum number of trials</span>
<span class="sd">            time_budget:</span>
<span class="sd">                An int variable of the maximum time budget</span>
<span class="sd">            custom_metric_name:</span>
<span class="sd">                A string of the dataset name or a function,</span>
<span class="sd">                e.g., &#39;accuracy&#39;, &#39;f1&#39;, &#39;loss&#39;</span>
<span class="sd">            custom_metric_mode_name:</span>
<span class="sd">                A string of the mode name,</span>
<span class="sd">                e.g., &quot;max&quot;, &quot;min&quot;, &quot;last&quot;, &quot;all&quot;</span>
<span class="sd">            ckpt_per_epoch:</span>
<span class="sd">                An integer value of number of checkpoints per epoch, default = 1</span>
<span class="sd">            ray_verbose:</span>
<span class="sd">                An integer, default=1 | verbosit of ray,</span>
<span class="sd">            transformers_verbose:</span>
<span class="sd">                An integer, default=transformers.logging.INFO | verbosity of transformers, must be chosen from one of</span>
<span class="sd">                transformers.logging.ERROR, transformers.logging.INFO, transformers.logging.WARNING,</span>
<span class="sd">                or transformers.logging.DEBUG</span>
<span class="sd">            fp16:</span>
<span class="sd">                A boolean, default = True | whether to use fp16</span>
<span class="sd">            ray_local_mode:</span>
<span class="sd">                A boolean, default = False | whether to use the local mode (debugging mode) for ray tune.run</span>
<span class="sd">            custom_hpo_args:</span>
<span class="sd">                The additional keyword arguments, e.g., custom_hpo_args = {&quot;points_to_evaluate&quot;: [{</span>
<span class="sd">                &quot;num_train_epochs&quot;: 1, &quot;per_device_train_batch_size&quot;: 128, }]}</span>

<span class="sd">        Returns:</span>

<span class="sd">            validation_metric: A dict storing the validation score</span>

<span class="sd">            analysis: A ray.tune.analysis.Analysis object storing the analysis results from tune.run</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.hpo.scheduler_auto</span> <span class="kn">import</span> <span class="n">AutoScheduler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transformers_verbose</span> <span class="o">=</span> <span class="n">transformers_verbose</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Specify the other parse of jobid configs from custom_hpo_args, e.g., if the search algorithm was not specified</span>
<span class="sd">         previously, can specify the algorithm here</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">custom_hpo_args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">set_jobid_from_console_args</span><span class="p">(</span><span class="n">console_args</span><span class="o">=</span><span class="n">custom_hpo_args</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_resources_per_trial</span> <span class="o">=</span> <span class="n">resources_per_trial</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_metric</span><span class="p">(</span><span class="n">custom_metric_name</span><span class="p">,</span> <span class="n">custom_metric_mode_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_task</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fp16</span> <span class="o">=</span> <span class="n">fp16</span>
        <span class="n">ray</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="n">ray</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">local_mode</span><span class="o">=</span><span class="n">ray_local_mode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_search_space</span><span class="p">(</span><span class="o">**</span><span class="n">custom_hpo_args</span><span class="p">)</span>

        <span class="n">search_algo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_search_algo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">alg</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">arg</span><span class="p">,</span>
                                            <span class="n">time_budget</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">metric_mode_name</span><span class="p">,</span>
                                            <span class="o">**</span><span class="n">custom_hpo_args</span><span class="p">)</span>
        <span class="n">scheduler</span> <span class="o">=</span> <span class="n">AutoScheduler</span><span class="o">.</span><span class="n">from_scheduler_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">pru</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ckpt_per_epoch</span> <span class="o">=</span> <span class="n">ckpt_per_epoch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_utils</span><span class="o">.</span><span class="n">make_dir_per_run</span><span class="p">()</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_utils</span><span class="o">.</span><span class="n">ckpt_dir_per_run</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">tune_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_space_hpo</span>
        <span class="n">tune_config</span><span class="p">[</span><span class="s2">&quot;seed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">sdhf</span>

        <span class="n">analysis</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">tune</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_objective</span><span class="p">,</span>
            <span class="n">metric</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metric_mode_name</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ray_result&quot;</span><span class="p">,</span>
            <span class="n">resources_per_trial</span><span class="o">=</span><span class="n">resources_per_trial</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">tune_config</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">ray_verbose</span><span class="p">,</span>
            <span class="n">local_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path_utils</span><span class="o">.</span><span class="n">ckpt_dir_per_run</span><span class="p">,</span>
            <span class="n">num_samples</span><span class="o">=</span><span class="n">num_samples</span><span class="p">,</span>
            <span class="n">time_budget_s</span><span class="o">=</span><span class="n">time_budget</span><span class="p">,</span>
            <span class="n">keep_checkpoints_num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">scheduler</span><span class="o">=</span><span class="n">scheduler</span><span class="p">,</span>
            <span class="n">search_alg</span><span class="o">=</span><span class="n">search_algo</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_run_duration</span> <span class="o">=</span> <span class="n">duration</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total running time: </span><span class="si">{}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">duration</span><span class="p">))</span>

        <span class="n">ray</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>

        <span class="n">best_trial</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">get_best_trial</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metric_mode_name</span><span class="p">)</span>
        <span class="n">validation_metric</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;eval_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span>
                             <span class="p">:</span> <span class="n">best_trial</span><span class="o">.</span><span class="n">metric_analysis</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">metric_mode_name</span><span class="p">]}</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_metrics</span><span class="p">)):</span>
            <span class="n">validation_metric</span><span class="p">[</span><span class="s2">&quot;eval_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_metrics</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span> \
                <span class="o">=</span> <span class="n">best_trial</span><span class="o">.</span><span class="n">metric_analysis</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_metrics</span><span class="p">[</span><span class="n">x</span><span class="p">]][</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_modes</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span>

        <span class="n">get_best_ckpt</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">get_best_checkpoint</span><span class="p">(</span><span class="n">best_trial</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metric_mode_name</span><span class="p">)</span>
        <span class="n">best_ckpt</span> <span class="o">=</span> <span class="n">AutoTransformers</span><span class="o">.</span><span class="n">_recover_checkpoint</span><span class="p">(</span><span class="n">get_best_ckpt</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_save_ckpt_json</span><span class="p">(</span><span class="n">best_ckpt</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">validation_metric</span><span class="p">,</span> <span class="n">analysis</span></div>

<div class="viewcode-block" id="AutoTransformers.predict"><a class="viewcode-back" href="../../../index.html#flaml.nlp.AutoTransformers.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">ckpt_json_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Predict label for test data.</span>

<span class="sd">        An example:</span>
<span class="sd">            predictions, test_metric = autohf.predict()</span>

<span class="sd">        Args:</span>
<span class="sd">            ckpt_json_dir:</span>
<span class="sd">                the checkpoint for the fine-tuned huggingface if you wish to override</span>
<span class="sd">                the saved checkpoint in the training stage under self.path_utils._result_dir_per_run</span>

<span class="sd">        Returns:</span>
<span class="sd">            A numpy array of shape n * 1 - - each element is a predicted class</span>
<span class="sd">            label for an instance.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">best_checkpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_ckpt_json</span><span class="p">(</span><span class="n">ckpt_json_dir</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">best_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_model</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="o">=</span><span class="n">best_checkpoint</span><span class="p">)</span>
        <span class="n">training_args</span> <span class="o">=</span> <span class="n">TrainingArguments</span><span class="p">(</span><span class="n">per_device_eval_batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                          <span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path_utils</span><span class="o">.</span><span class="n">result_dir_per_run</span><span class="p">)</span>
        <span class="n">test_trainer</span> <span class="o">=</span> <span class="n">TrainerForAutoTransformers</span><span class="p">(</span><span class="n">best_model</span><span class="p">,</span> <span class="n">training_args</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">spt</span> <span class="o">==</span> <span class="s2">&quot;ori&quot;</span><span class="p">:</span>
            <span class="c1"># TODO add test</span>
            <span class="k">if</span> <span class="s2">&quot;label&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_dataset</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">test_dataset</span><span class="o">.</span><span class="n">remove_columns_</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cleaning the existing label column from test data&quot;</span><span class="p">)</span>

        <span class="n">test_dataloader</span> <span class="o">=</span> <span class="n">test_trainer</span><span class="o">.</span><span class="n">get_test_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_dataset</span><span class="p">)</span>
        <span class="n">predictions</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">test_trainer</span><span class="o">.</span><span class="n">prediction_loop</span><span class="p">(</span><span class="n">test_dataloader</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Prediction&quot;</span><span class="p">)</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span> \
            <span class="k">if</span> <span class="n">get_default_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">dat</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">subdat</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;regression&quot;</span> \
            <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">spt</span> <span class="o">==</span> <span class="s2">&quot;rspt&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_metric_func</span><span class="p">()</span>
            <span class="n">output_metric</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">predictions</span><span class="o">=</span><span class="n">predictions</span><span class="p">,</span> <span class="n">references</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_output_metric</span><span class="p">(</span><span class="n">output_metric</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">output_metric</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">predictions</span><span class="p">,</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="AutoTransformers.output_prediction"><a class="viewcode-back" href="../../../index.html#flaml.nlp.AutoTransformers.output_prediction">[docs]</a>    <span class="k">def</span> <span class="nf">output_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">predictions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">output_prediction_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">output_zip_file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            When using the original GLUE split, output the prediction on test data,</span>
<span class="sd">            and prepare the .zip file for submission</span>

<span class="sd">            Example:</span>
<span class="sd">                local_archive_path = self.autohf.output_prediction(predictions,</span>
<span class="sd">                                      output_prediction_path= self.console_args.data_root_dir + &quot;result/&quot;,</span>
<span class="sd">                                      output_zip_file_name=azure_save_file_name)</span>

<span class="sd">            Args:</span>
<span class="sd">                predictions:</span>
<span class="sd">                    A list of predictions, which is the output of AutoTransformers.predict()</span>
<span class="sd">                output_prediction_path:</span>
<span class="sd">                    Output path for the prediction</span>
<span class="sd">                output_zip_file_name:</span>
<span class="sd">                    An string, which is the name of the output zip file</span>

<span class="sd">            Returns:</span>
<span class="sd">                The path of the output .zip file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.dataset.submission_auto</span> <span class="kn">import</span> <span class="n">auto_output_prediction</span>
        <span class="k">return</span> <span class="n">auto_output_prediction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">dat</span><span class="p">,</span>
                                      <span class="n">output_prediction_path</span><span class="p">,</span>
                                      <span class="n">output_zip_file_name</span><span class="p">,</span>
                                      <span class="n">predictions</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_dev_name</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">jobid_config</span><span class="o">.</span><span class="n">subdat</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020-2021, FLAML Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>