<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>flaml.nlp.result_analysis.azure_utils &mdash; FLAML  documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../index.html" class="icon icon-home"> FLAML
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">FLAML</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
      <li>flaml.nlp.result_analysis.azure_utils</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for flaml.nlp.result_analysis.azure_utils</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="nn">argparse</span>


<span class="k">class</span> <span class="nc">ConfigScore</span><span class="p">:</span>
    <span class="n">trial_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">last_update_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">metric_score</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">time_stamp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">trial_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">last_update_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">metric_score</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">time_stamp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>
                 <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trial_id</span> <span class="o">=</span> <span class="n">trial_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">start_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_update_time</span> <span class="o">=</span> <span class="n">last_update_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric_score</span> <span class="o">=</span> <span class="n">metric_score</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_stamp</span> <span class="o">=</span> <span class="n">time_stamp</span>


<span class="k">class</span> <span class="nc">ConfigScoreList</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">config_score_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ConfigScore</span><span class="p">],</span>
                 <span class="n">jobid_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">blob_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config_score_list</span> <span class="o">=</span> <span class="n">config_score_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_blob_file</span> <span class="o">=</span> <span class="n">blob_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_jobid_config</span> <span class="o">=</span> <span class="n">jobid_config</span>

    <span class="k">def</span> <span class="nf">sorted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort_method</span><span class="o">=</span><span class="s2">&quot;unsorted&quot;</span><span class="p">,</span> <span class="n">metric_mode</span><span class="o">=</span><span class="s2">&quot;max&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sort_method</span> <span class="o">==</span> <span class="s2">&quot;unsorted&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config_score_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_score_list</span>
        <span class="k">elif</span> <span class="n">sort_method</span> <span class="o">==</span> <span class="s2">&quot;sort_time&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config_score_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_score_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config_score_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_score_list</span><span class="p">,</span>
                                             <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;metric_score&quot;</span><span class="p">)</span>
                                             <span class="p">[</span><span class="n">metric_mode</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_best_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">metric_mode</span><span class="o">=</span><span class="s2">&quot;max&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_score_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;metric_score&quot;</span><span class="p">)[</span><span class="n">metric_mode</span><span class="p">])</span>


<div class="viewcode-block" id="JobID"><a class="viewcode-back" href="../../../../index.html#flaml.nlp.JobID">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">JobID</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The class for specifying the config of a job, includes the following fields:</span>

<span class="sd">        dat:</span>
<span class="sd">            A list which is the dataset name</span>
<span class="sd">        subdat:</span>
<span class="sd">            A string which is the sub dataset name</span>
<span class="sd">        mod:</span>
<span class="sd">            A string which is the module, e.g., &quot;grid&quot;, &quot;hpo&quot;</span>
<span class="sd">        spa:</span>
<span class="sd">            A string which is the space mode, e.g., &quot;uni&quot;, &quot;gnr&quot;</span>
<span class="sd">        arg:</span>
<span class="sd">            A string which is the mode for setting the input argument of a search algorithm, e.g., &quot;cus&quot;, &quot;dft&quot;</span>
<span class="sd">        alg:</span>
<span class="sd">            A string which is the search algorithm name</span>
<span class="sd">        pru:</span>
<span class="sd">            A string which is the scheduler name</span>
<span class="sd">        pre_full:</span>
<span class="sd">            A string which is the full name of the pretrained language model</span>
<span class="sd">        pre:</span>
<span class="sd">            A string which is the abbreviation of the pretrained language model</span>
<span class="sd">        presz:</span>
<span class="sd">            A string which is the size of the pretrained language model</span>
<span class="sd">        spt:</span>
<span class="sd">            A string which is the resplit mode, e.g., &quot;ori&quot;, &quot;rspt&quot;</span>
<span class="sd">        rep:</span>
<span class="sd">            An integer which is the repetition id</span>
<span class="sd">        sddt:</span>
<span class="sd">            An integer which is the seed for data shuffling in the resplit mode</span>
<span class="sd">        sdhf:</span>
<span class="sd">            An integer which is the seed for transformers</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dat</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">subdat</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">mod</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">spa</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">arg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">alg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">pru</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">pre_full</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">pre</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">presz</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">spt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">rep</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">sddt</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">sdhf</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">console_args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">console_args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_jobid_from_console_args</span><span class="p">(</span><span class="n">console_args</span><span class="p">)</span>

<div class="viewcode-block" id="JobID.set_unittest_config"><a class="viewcode-back" href="../../../../index.html#flaml.nlp.JobID.set_unittest_config">[docs]</a>    <span class="k">def</span> <span class="nf">set_unittest_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            set the JobID config for unit test</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dat</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;glue&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subdat</span> <span class="o">=</span> <span class="s2">&quot;mrpc&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mod</span> <span class="o">=</span> <span class="s2">&quot;hpo&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spa</span> <span class="o">=</span> <span class="s2">&quot;uni_test&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg</span> <span class="o">=</span> <span class="s2">&quot;cus&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alg</span> <span class="o">=</span> <span class="s2">&quot;bs&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pru</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre_full</span> <span class="o">=</span> <span class="s2">&quot;google/mobilebert-uncased&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre</span> <span class="o">=</span> <span class="s2">&quot;mobilebert&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">presz</span> <span class="o">=</span> <span class="s2">&quot;small&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spt</span> <span class="o">=</span> <span class="s2">&quot;rspt&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rep</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sddt</span> <span class="o">=</span> <span class="mi">43</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sdhf</span> <span class="o">=</span> <span class="mi">42</span></div>

<div class="viewcode-block" id="JobID.is_match"><a class="viewcode-back" href="../../../../index.html#flaml.nlp.JobID.is_match">[docs]</a>    <span class="k">def</span> <span class="nf">is_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partial_jobid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a boolean variable whether the current object matches the partial jobid defined in partial_jobid.</span>

<span class="sd">           Example:</span>

<span class="sd">               .. code-block:: python</span>

<span class="sd">                   self = JobID(dat = [&#39;glue&#39;], subdat = &#39;cola&#39;, mod = &#39;bestnn&#39;, spa = &#39;buni&#39;, arg = &#39;cus&#39;, alg = &#39;bs&#39;,</span>
<span class="sd">                                pru = &#39;None&#39;, pre = &#39;funnel&#39;, presz = &#39;xlarge&#39;, spt = &#39;rspt&#39;, rep = 0, sddt = 43, sdhf = 42)</span>

<span class="sd">                   partial_jobid1 = JobID(dat = [&#39;glue&#39;],</span>
<span class="sd">                                          subdat = &#39;cola&#39;,</span>
<span class="sd">                                          mod = &#39;hpo&#39;)</span>

<span class="sd">                   partial_jobid2 = JobID(dat = [&#39;glue&#39;],</span>
<span class="sd">                                          subdat = &#39;cola&#39;,</span>
<span class="sd">                                          mod = &#39;bestnn&#39;)</span>

<span class="sd">            return False for partial_jobid1 and True for partial_jobid2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">is_not_match</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">partial_jobid</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="o">!=</span> <span class="n">val</span><span class="p">:</span>
                <span class="n">is_not_match</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">is_not_match</span></div>

<div class="viewcode-block" id="JobID.to_wandb_string"><a class="viewcode-back" href="../../../../index.html#flaml.nlp.JobID.to_wandb_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_wandb_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Preparing for the job ID for wandb</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="n">keytoval_str</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">JobID</span><span class="o">.</span><span class="n">dataset_list_to_str</span><span class="p">(</span><span class="n">field_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                                 <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">field_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">==</span> <span class="nb">list</span>
                                 <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">field_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                                 <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">field_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_full&quot;</span><span class="p">)])</span>
        <span class="k">return</span> <span class="n">keytoval_str</span></div>

<div class="viewcode-block" id="JobID.to_jobid_string"><a class="viewcode-back" href="../../../../index.html#flaml.nlp.JobID.to_jobid_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_jobid_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Convert the current JobID into a blob name string which contains all the fields</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">list_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">JobID</span><span class="o">.</span><span class="n">__dataclass_fields__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">field_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="n">keytoval_str</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="n">JobID</span><span class="o">.</span><span class="n">dataset_list_to_str</span><span class="p">(</span><span class="n">field_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                                 <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">field_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">==</span> <span class="nb">list</span>
                                 <span class="k">else</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">field_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                                 <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">list_keys</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_full&quot;</span><span class="p">)])</span>
        <span class="k">return</span> <span class="n">keytoval_str</span></div>

<div class="viewcode-block" id="JobID.to_partial_jobid_string"><a class="viewcode-back" href="../../../../index.html#flaml.nlp.JobID.to_partial_jobid_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_partial_jobid_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Convert the current JobID into a blob name string which only contains the fields whose values are not &quot;None&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">list_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">JobID</span><span class="o">.</span><span class="n">__dataclass_fields__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">field_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>  <span class="c1"># field_dict contains fields whose values are not None</span>
        <span class="n">keytoval_str</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="n">JobID</span><span class="o">.</span><span class="n">dataset_list_to_str</span><span class="p">(</span><span class="n">field_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                                 <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">field_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">==</span> <span class="nb">list</span>
                                 <span class="k">else</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">field_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                                 <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">list_keys</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">field_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
        <span class="k">return</span> <span class="n">keytoval_str</span></div>

<div class="viewcode-block" id="JobID.blobname_to_jobid_dict"><a class="viewcode-back" href="../../../../index.html#flaml.nlp.JobID.blobname_to_jobid_dict">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">blobname_to_jobid_dict</span><span class="p">(</span><span class="n">keytoval_str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Converting an azure blobname to a JobID config,</span>
<span class="sd">            e.g., blobname = &quot;dat=glue_subdat=cola_mod=bestnn_spa=buni_arg=cus_</span>
<span class="sd">            alg=bs_pru=None_pre=funnel_presz=xlarge_spt=rspt_rep=0.json&quot;</span>

<span class="sd">            the converted jobid dict = {dat = [&#39;glue&#39;], subdat = &#39;cola&#39;, mod = &#39;bestnn&#39;,</span>
<span class="sd">                                   spa = &#39;buni&#39;, arg = &#39;cus&#39;, alg = &#39;bs&#39;, pru = &#39;None&#39;,</span>
<span class="sd">                                   pre = &#39;funnel&#39;, presz = &#39;xlarge&#39;, spt = &#39;rspt&#39;,</span>
<span class="sd">                                   rep = 0, sddt = 43, sdhf = 42)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">JobID</span><span class="o">.</span><span class="n">__dataclass_fields__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_full&quot;</span><span class="p">)]</span>
        <span class="n">regex_expression</span> <span class="o">=</span> <span class="s2">&quot;.*&quot;</span>
        <span class="n">is_first</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">field_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_first</span><span class="p">:</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">is_first</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;sd&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;var&quot;</span><span class="p">):</span>
                <span class="n">regex_expression</span> <span class="o">+=</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;=(?P&lt;&quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;&gt;[^_]*))?&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">regex_expression</span> <span class="o">+=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;=(?P&lt;&quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;&gt;[^_]*)&quot;</span>
        <span class="n">regex_expression</span> <span class="o">+=</span> <span class="s2">&quot;.(json|zip)&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">regex_expression</span><span class="p">,</span> <span class="n">keytoval_str</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">result_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">field_keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;dat&quot;</span><span class="p">:</span>
                    <span class="n">result_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;rep&quot;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">result_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No group </span><span class="si">{}</span><span class="s2"> in the regex result&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                            <span class="n">result_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cannot parse integer </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">key</span><span class="p">)))</span>
                        <span class="n">result_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result_dict</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">dataset_list_to_str</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;dat&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dataset_name</span>

<div class="viewcode-block" id="JobID.set_jobid_from_arg_list"><a class="viewcode-back" href="../../../../index.html#flaml.nlp.JobID.set_jobid_from_arg_list">[docs]</a>    <span class="k">def</span> <span class="nf">set_jobid_from_arg_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                <span class="o">**</span><span class="n">jobid_list</span>
                                <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Set the jobid from a dict object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">jobid_list</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">assert</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">JobID</span><span class="o">.</span><span class="n">__dataclass_fields__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">jobid_list</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mod</span> <span class="o">==</span> <span class="s2">&quot;grid&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alg</span> <span class="o">=</span> <span class="s2">&quot;grid&quot;</span></div>

<div class="viewcode-block" id="JobID.convert_blobname_to_jobid"><a class="viewcode-back" href="../../../../index.html#flaml.nlp.JobID.convert_blobname_to_jobid">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">convert_blobname_to_jobid</span><span class="p">(</span><span class="n">blobname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Converting a blobname string to a JobID object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">jobconfig_dict</span> <span class="o">=</span> <span class="n">JobID</span><span class="o">.</span><span class="n">blobname_to_jobid_dict</span><span class="p">(</span><span class="n">blobname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">jobconfig_dict</span><span class="p">:</span>
            <span class="n">jobconfig</span> <span class="o">=</span> <span class="n">JobID</span><span class="p">()</span>
            <span class="n">jobconfig</span><span class="o">.</span><span class="n">set_jobid_from_arg_list</span><span class="p">(</span><span class="o">**</span><span class="n">jobconfig_dict</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">jobconfig</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="JobID.get_full_data_name"><a class="viewcode-back" href="../../../../index.html#flaml.nlp.JobID.get_full_data_name">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_full_data_name</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">subdataset_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Convert a dataset name and sub dataset name to a full dataset name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">full_dataset_name</span> <span class="o">=</span> <span class="n">JobID</span><span class="o">.</span><span class="n">dataset_list_to_str</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">full_dataset_name</span> <span class="o">=</span> <span class="n">dataset_name</span>
        <span class="k">if</span> <span class="n">subdataset_name</span><span class="p">:</span>
            <span class="n">full_dataset_name</span> <span class="o">=</span> <span class="n">full_dataset_name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">subdataset_name</span>
        <span class="k">return</span> <span class="n">full_dataset_name</span></div>

<div class="viewcode-block" id="JobID.get_jobid_full_data_name"><a class="viewcode-back" href="../../../../index.html#flaml.nlp.JobID.get_jobid_full_data_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_jobid_full_data_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get the full dataset name of the current JobID object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">JobID</span><span class="o">.</span><span class="n">get_full_data_name</span><span class="p">(</span><span class="n">JobID</span><span class="o">.</span><span class="n">dataset_list_to_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dat</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdat</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_extract_model_type_with_keywords_match</span><span class="p">(</span><span class="n">pre_full</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">..hpo.grid_searchspace_auto</span> <span class="kn">import</span> <span class="n">HF_MODEL_LIST</span>
        <span class="n">matched_model_type</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">each_model_type</span> <span class="ow">in</span> <span class="n">HF_MODEL_LIST</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">each_model_type</span> <span class="ow">in</span> <span class="n">pre_full</span><span class="p">:</span>
                <span class="n">matched_model_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">each_model_type</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_model_type</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">matched_model_type</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">extract_model_type</span><span class="p">(</span><span class="n">full_model_name</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoConfig</span>
        <span class="n">model_config</span> <span class="o">=</span> <span class="n">AutoConfig</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">full_model_name</span><span class="p">)</span>
        <span class="n">config_json_file</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">get_config_dict</span><span class="p">(</span><span class="n">full_model_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">model_type</span> <span class="o">=</span> <span class="n">config_json_file</span><span class="p">[</span><span class="s2">&quot;model_type&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;config_json_file does not contain model_type, re-extracting with keywords matching&quot;</span><span class="p">)</span>
            <span class="n">model_type</span> <span class="o">=</span> <span class="n">JobID</span><span class="o">.</span><span class="n">_extract_model_type_with_keywords_match</span><span class="p">(</span><span class="n">full_model_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model_type</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_attrval_from_arg_or_dict</span><span class="p">(</span><span class="n">console_args</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">,</span> <span class="nb">dict</span><span class="p">],</span> <span class="n">each_key</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">console_args</span><span class="p">)</span> <span class="o">==</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">console_args</span><span class="p">,</span> <span class="n">each_key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">console_args</span><span class="p">[</span><span class="n">each_key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">set_jobid_from_console_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">console_args</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]):</span>
        <span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">pretrained_model_size_format_check</span><span class="p">,</span> <span class="n">dataset_subdataset_name_format_check</span>
        <span class="n">console_to_jobid_key_mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;pretrained_model_size&quot;</span><span class="p">:</span> <span class="s2">&quot;pre&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dataset_subdataset_name&quot;</span><span class="p">:</span> <span class="s2">&quot;dat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;algo_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;mod&quot;</span><span class="p">,</span>
            <span class="s2">&quot;space_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;spa&quot;</span><span class="p">,</span>
            <span class="s2">&quot;search_alg_args_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;arg&quot;</span><span class="p">,</span>
            <span class="s2">&quot;algo_name&quot;</span><span class="p">:</span> <span class="s2">&quot;alg&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pruner&quot;</span><span class="p">:</span> <span class="s2">&quot;pru&quot;</span><span class="p">,</span>
            <span class="s2">&quot;resplit_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;spt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rep_id&quot;</span><span class="p">:</span> <span class="s2">&quot;rep&quot;</span><span class="p">,</span>
            <span class="s2">&quot;seed_data&quot;</span><span class="p">:</span> <span class="s2">&quot;sddt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;seed_transformers&quot;</span><span class="p">:</span> <span class="s2">&quot;sdhf&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">each_key</span> <span class="ow">in</span> <span class="n">console_to_jobid_key_mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">each_key</span> <span class="o">==</span> <span class="s2">&quot;dataset_subdataset_name&quot;</span><span class="p">:</span>
                        <span class="n">dataset_subdataset_name_format_check</span><span class="p">(</span><span class="n">JobID</span><span class="o">.</span><span class="n">get_attrval_from_arg_or_dict</span><span class="p">(</span><span class="n">console_args</span><span class="p">,</span> <span class="n">each_key</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dat</span> <span class="o">=</span> <span class="n">JobID</span><span class="o">.</span><span class="n">get_attrval_from_arg_or_dict</span><span class="p">(</span><span class="n">console_args</span><span class="p">,</span> <span class="n">each_key</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">subdat</span> <span class="o">=</span> <span class="n">JobID</span><span class="o">.</span><span class="n">get_attrval_from_arg_or_dict</span><span class="p">(</span><span class="n">console_args</span><span class="p">,</span> <span class="n">each_key</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">each_key</span> <span class="o">==</span> <span class="s2">&quot;pretrained_model_size&quot;</span><span class="p">:</span>
                        <span class="n">pretrained_model_size_format_check</span><span class="p">(</span><span class="n">JobID</span><span class="o">.</span><span class="n">get_attrval_from_arg_or_dict</span><span class="p">(</span><span class="n">console_args</span><span class="p">,</span> <span class="n">each_key</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pre_full</span> <span class="o">=</span> <span class="n">JobID</span><span class="o">.</span><span class="n">get_attrval_from_arg_or_dict</span><span class="p">(</span><span class="n">console_args</span><span class="p">,</span> <span class="n">each_key</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pre</span> <span class="o">=</span> <span class="n">JobID</span><span class="o">.</span><span class="n">extract_model_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre_full</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">presz</span> <span class="o">=</span> <span class="n">JobID</span><span class="o">.</span><span class="n">get_attrval_from_arg_or_dict</span><span class="p">(</span><span class="n">console_args</span><span class="p">,</span> <span class="n">each_key</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">jobid_key</span> <span class="o">=</span> <span class="n">console_to_jobid_key_mapping</span><span class="p">[</span><span class="n">each_key</span><span class="p">]</span>
                        <span class="n">attrval</span> <span class="o">=</span> <span class="n">JobID</span><span class="o">.</span><span class="n">get_attrval_from_arg_or_dict</span><span class="p">(</span><span class="n">console_args</span><span class="p">,</span> <span class="n">each_key</span><span class="p">)</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobid_key</span><span class="p">,</span> <span class="n">attrval</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;console_args has no attribute </span><span class="si">{}</span><span class="s2">, continue&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">each_key</span><span class="p">))</span>
                    <span class="k">continue</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;console_args has no attribute </span><span class="si">{}</span><span class="s2">, continue&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">each_key</span><span class="p">))</span>
                <span class="k">continue</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mod</span> <span class="o">==</span> <span class="s2">&quot;grid&quot;</span><span class="p">:</span>
            <span class="c1"># TODO coverage</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alg</span> <span class="o">=</span> <span class="s2">&quot;grid&quot;</span></div>


<div class="viewcode-block" id="AzureUtils"><a class="viewcode-back" href="../../../../index.html#flaml.nlp.AzureUtils">[docs]</a><span class="k">class</span> <span class="nc">AzureUtils</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">root_log_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">azure_key_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">data_root_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">autohf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">jobid_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; This class is for saving the output files (logs, predictions) for HPO, uploading it to an azure storage</span>
<span class="sd">            blob, and performing analysis on the saved blobs. To use the cloud storage, you need to specify a key</span>
<span class="sd">            and upload the output files to azure. For example, when running jobs in a cluster, this class can</span>
<span class="sd">            help you store all the output files in the same place. If a key is not specified, this class will help you</span>
<span class="sd">            save the files locally but not uploading to the cloud. After the outputs are uploaded, you can use this</span>
<span class="sd">            class to perform analysis on the uploaded blob files.</span>

<span class="sd">            Examples:</span>

<span class="sd">                Example 1 (saving and uploading):</span>

<span class="sd">                    validation_metric, analysis = autohf.fit(**autohf_settings) # running HPO</span>
<span class="sd">                    predictions, test_metric = autohf.predict()</span>

<span class="sd">                    azure_utils = AzureUtils(root_log_path=&quot;logs_test/&quot;,</span>
<span class="sd">                                             autohf=autohf,</span>
<span class="sd">                                             azure_key_path=&quot;../../&quot;)</span>
<span class="sd">                                             # passing the azure blob key from key.json under azure_key_path</span>

<span class="sd">                    azure_utils.write_autohf_output(valid_metric=validation_metric,</span>
<span class="sd">                                                    predictions=predictions,</span>
<span class="sd">                                                    duration=autohf.last_run_duration)</span>
<span class="sd">                                    # uploading the output to azure cloud, which can be used for analysis afterwards</span>

<span class="sd">                Example 2 (analysis):</span>

<span class="sd">                        jobid_config = JobID()</span>
<span class="sd">                        jobid_config.mod = &quot;grid&quot;</span>
<span class="sd">                        jobid_config.pre = &quot;funnel&quot;</span>
<span class="sd">                        jobid_config.presz = &quot;xlarge&quot;</span>

<span class="sd">                        azure_utils = AzureUtils(root_log_path= &quot;logs_test/&quot;,</span>
<span class="sd">                                                 azure_key_path = &quot;../../&quot;,</span>
<span class="sd">                                                 jobid_config=jobid_config)</span>

<span class="sd">                        # continue analyzing all files in azure blob that matches jobid_config</span>

<span class="sd">            Args:</span>
<span class="sd">                root_log_path:</span>
<span class="sd">                    The local root log folder name, e.g., root_log_path=&quot;logs_test/&quot; will create a directory</span>
<span class="sd">                    &quot;logs_test/&quot; locally</span>

<span class="sd">                azure_key_path:</span>
<span class="sd">                    The path for storing the azure keys. The azure key, and container name are stored in a local file</span>
<span class="sd">                    azure_key_path/key.json. The key_path.json file should look like this:</span>

<span class="sd">                    {</span>
<span class="sd">                        &quot;container_name&quot;: &quot;container_name&quot;,</span>
<span class="sd">                        &quot;azure_key&quot;: &quot;azure_key&quot;,</span>
<span class="sd">                    }</span>

<span class="sd">                    To find out the container name and azure key of your blob, please refer to:</span>
<span class="sd">                    https://docs.microsoft.com/en-us/azure/storage/blobs/storage-quickstart-blobs-portal</span>

<span class="sd">                    If the container name and azure key are not specified, the output will only be saved locally,</span>
<span class="sd">                    not synced to azure blob.</span>

<span class="sd">                data_root_dir:</span>
<span class="sd">                    The directory for outputing the predictions, e.g., packing the predictions into a .zip file for</span>
<span class="sd">                    uploading to the glue website</span>

<span class="sd">                autohf:</span>
<span class="sd">                    The AutoTransformers object, which contains the output of an HPO run. AzureUtils will save the</span>
<span class="sd">                    output (analysis results, predictions) from AzureTransformers.</span>

<span class="sd">                jobid_config:</span>
<span class="sd">                    The jobid config for analysis. jobid_config specifies the jobid config of azure blob files</span>
<span class="sd">                    to be analyzed, if autohf is specified, jobid_config will be overwritten by autohf.jobid_config</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">root_log_path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root_log_path</span> <span class="o">=</span> <span class="n">root_log_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root_log_path</span> <span class="o">=</span> <span class="s2">&quot;logs_azure/&quot;</span>
        <span class="k">if</span> <span class="n">autohf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jobid</span> <span class="o">=</span> <span class="n">autohf</span><span class="o">.</span><span class="n">jobid_config</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># TODO coverage</span>
            <span class="k">assert</span> <span class="n">jobid_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;jobid_config must be passed either through autohf.jobid_config&quot;</span> \
                                             <span class="s2">&quot; or jobid_config&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jobid</span> <span class="o">=</span> <span class="n">jobid_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_root_dir</span> <span class="o">=</span> <span class="n">data_root_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autohf</span> <span class="o">=</span> <span class="n">autohf</span>
        <span class="k">if</span> <span class="n">azure_key_path</span><span class="p">:</span>
            <span class="n">azure_key</span><span class="p">,</span> <span class="n">container_name</span> <span class="o">=</span> <span class="n">AzureUtils</span><span class="o">.</span><span class="n">get_azure_key</span><span class="p">(</span><span class="n">azure_key_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_container_name</span> <span class="o">=</span> <span class="n">container_name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_azure_key</span> <span class="o">=</span> <span class="n">azure_key</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_container_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_azure_key</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_azure_key</span><span class="p">(</span><span class="n">key_path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">key_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">key_path</span><span class="p">,</span> <span class="s2">&quot;key.json&quot;</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">))</span>
                <span class="n">azure_key</span> <span class="o">=</span> <span class="n">key_json</span><span class="p">[</span><span class="s2">&quot;azure_key&quot;</span><span class="p">]</span>
                <span class="n">azure_container_name</span> <span class="o">=</span> <span class="n">key_json</span><span class="p">[</span><span class="s2">&quot;container_name&quot;</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">azure_key</span><span class="p">,</span> <span class="n">azure_container_name</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Your output will not be synced to azure because key.json is not found under key_path&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Your output will not be synced to azure because azure key and container name are not specified&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_get_complete_connection_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;DefaultEndpointsProtocol=https;AccountName=docws5141197765;AccountKey=&quot;</span> \
                   <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_azure_key</span> <span class="o">+</span> <span class="s2">&quot;;EndpointSuffix=core.windows.net&quot;</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;DefaultEndpointsProtocol=https;AccountName=docws5141197765;AccountKey=&quot;</span> \
                   <span class="s2">&quot;;EndpointSuffix=core.windows.net&quot;</span>

    <span class="k">def</span> <span class="nf">_init_azure_clients</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">azure.storage.blob</span> <span class="kn">import</span> <span class="n">ContainerClient</span>
            <span class="n">connection_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_complete_connection_string</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">container_client</span> <span class="o">=</span> <span class="n">ContainerClient</span><span class="o">.</span><span class="n">from_connection_string</span><span class="p">(</span><span class="n">conn_str</span><span class="o">=</span><span class="n">connection_string</span><span class="p">,</span>
                                                                          <span class="n">container_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_container_name</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">container_client</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Your output will not be synced to azure because azure key and container name are not specified&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Your output will not be synced to azure because azure-blob-storage is not installed&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_blob_client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">local_file_path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">azure.storage.blob</span> <span class="kn">import</span> <span class="n">BlobServiceClient</span>

            <span class="n">connection_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_complete_connection_string</span><span class="p">()</span>
            <span class="n">blob_service_client</span> <span class="o">=</span> <span class="n">BlobServiceClient</span><span class="o">.</span><span class="n">from_connection_string</span><span class="p">(</span><span class="n">connection_string</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">blob_client</span> <span class="o">=</span> <span class="n">blob_service_client</span><span class="o">.</span><span class="n">get_blob_client</span><span class="p">(</span><span class="n">container</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_container_name</span><span class="p">,</span> <span class="n">blob</span><span class="o">=</span><span class="n">local_file_path</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">blob_client</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Your output will not be synced to azure because azure key and container name are not specified&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Your output will not be synced to azure because azure-blob-storage is not installed&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">upload_local_file_to_azure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local_file_path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">azure.core.exceptions</span> <span class="kn">import</span> <span class="n">HttpResponseError</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">blob_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_blob_client</span><span class="p">(</span><span class="n">local_file_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">blob_client</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">local_file_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
                        <span class="n">blob_client</span><span class="o">.</span><span class="n">upload_blob</span><span class="p">(</span><span class="n">fin</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">HttpResponseError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cannot upload blob due to </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;azure.core.exceptions.HttpResponseError&quot;</span><span class="p">,</span>
                                                                <span class="n">err</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Your output will not be synced to azure because azure-blob-storage is not installed&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">download_azure_blob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blobname</span><span class="p">):</span>
        <span class="c1"># TODO coverage</span>
        <span class="n">blob_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_blob_client</span><span class="p">(</span><span class="n">blobname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">blob_client</span><span class="p">:</span>
            <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;(?P&lt;parent_path&gt;^.*)/[^/]+$&quot;</span><span class="p">,</span> <span class="n">blobname</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;parent_path&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span>
                <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">blobname</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
                <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">blob_client</span><span class="o">.</span><span class="n">download_blob</span><span class="p">()</span><span class="o">.</span><span class="n">readall</span><span class="p">())</span>

<div class="viewcode-block" id="AzureUtils.extract_configscore_list_from_analysis"><a class="viewcode-back" href="../../../../index.html#flaml.nlp.AzureUtils.extract_configscore_list_from_analysis">[docs]</a>    <span class="k">def</span> <span class="nf">extract_configscore_list_from_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                               <span class="n">analysis</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Extracting a json object for storing the key information returned from tune.run</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">configscore_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">each_trial</span> <span class="ow">in</span> <span class="n">analysis</span><span class="o">.</span><span class="n">trials</span><span class="p">:</span>
            <span class="n">trial_id</span> <span class="o">=</span> <span class="n">each_trial</span><span class="o">.</span><span class="n">trial_id</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">each_trial</span><span class="o">.</span><span class="n">start_time</span>
            <span class="n">last_update_time</span> <span class="o">=</span> <span class="n">each_trial</span><span class="o">.</span><span class="n">last_update_time</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">each_trial</span><span class="o">.</span><span class="n">config</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metric_score</span> <span class="o">=</span> <span class="n">each_trial</span><span class="o">.</span><span class="n">metric_analysis</span><span class="p">[</span><span class="s2">&quot;eval_&quot;</span> <span class="o">+</span> <span class="n">analysis</span><span class="o">.</span><span class="n">default_metric</span><span class="p">]</span>
                <span class="n">time_stamp</span> <span class="o">=</span> <span class="n">each_trial</span><span class="o">.</span><span class="n">metric_analysis</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="c1"># TODO coverage</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;KeyError, </span><span class="si">{}</span><span class="s2"> does not contain the key </span><span class="si">{}</span><span class="s2"> or </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;each_trial.metric_analysis&quot;</span><span class="p">,</span>
                                                                              <span class="s2">&quot;eval_&quot;</span> <span class="o">+</span> <span class="n">analysis</span><span class="o">.</span><span class="n">default_metric</span><span class="p">,</span>
                                                                              <span class="s2">&quot;timestamp&quot;</span><span class="p">))</span>
                <span class="n">metric_score</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">time_stamp</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">configscore_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ConfigScore</span><span class="p">(</span>
                <span class="n">trial_id</span><span class="o">=</span><span class="n">trial_id</span><span class="p">,</span>
                <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">,</span>
                <span class="n">last_update_time</span><span class="o">=</span><span class="n">last_update_time</span><span class="p">,</span>
                <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                <span class="n">metric_score</span><span class="o">=</span><span class="n">metric_score</span><span class="p">,</span>
                <span class="n">time_stamp</span><span class="o">=</span><span class="n">time_stamp</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">configscore_list</span></div>

<div class="viewcode-block" id="AzureUtils.write_autohf_output"><a class="viewcode-back" href="../../../../index.html#flaml.nlp.AzureUtils.write_autohf_output">[docs]</a>    <span class="k">def</span> <span class="nf">write_autohf_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="n">configscore_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">valid_metric</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">predictions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">duration</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Write the key info from a job and upload to azure blob storage</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">local_file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_local_json_path</span><span class="p">()</span>
        <span class="n">output_json</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">configscore_list</span><span class="p">:</span>
            <span class="n">output_json</span><span class="p">[</span><span class="s2">&quot;val_log&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">configscore</span><span class="o">.</span><span class="vm">__dict__</span> <span class="k">for</span> <span class="n">configscore</span> <span class="ow">in</span> <span class="n">configscore_list</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">valid_metric</span><span class="p">:</span>
            <span class="n">output_json</span><span class="p">[</span><span class="s2">&quot;valid_metric&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_metric</span>
        <span class="k">if</span> <span class="n">duration</span><span class="p">:</span>
            <span class="n">output_json</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">duration</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_json</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_local_json_and_upload</span><span class="p">(</span><span class="n">output_json</span><span class="p">,</span> <span class="n">local_file_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">predictions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_local_prediction_and_upload</span><span class="p">(</span><span class="n">local_file_path</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)</span></div>

<div class="viewcode-block" id="AzureUtils.generate_local_json_path"><a class="viewcode-back" href="../../../../index.html#flaml.nlp.AzureUtils.generate_local_json_path">[docs]</a>    <span class="k">def</span> <span class="nf">generate_local_json_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Return a path string for storing the json file locally</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">full_dataset_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobid</span><span class="o">.</span><span class="n">get_jobid_full_data_name</span><span class="p">()</span>
        <span class="n">jobid_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobid</span><span class="o">.</span><span class="n">to_jobid_string</span><span class="p">()</span>
        <span class="n">local_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_log_path</span><span class="p">,</span> <span class="n">full_dataset_name</span><span class="p">,</span> <span class="n">jobid_str</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">)</span>
        <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_log_path</span><span class="p">,</span> <span class="n">full_dataset_name</span><span class="p">))</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">local_file_path</span></div>

    <span class="k">def</span> <span class="nf">create_local_json_and_upload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result_json</span><span class="p">,</span> <span class="n">local_file_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">local_file_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result_json</span><span class="p">))</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">upload_local_file_to_azure</span><span class="p">(</span><span class="n">local_file_path</span><span class="p">)</span>

<div class="viewcode-block" id="AzureUtils.create_local_prediction_and_upload"><a class="viewcode-back" href="../../../../index.html#flaml.nlp.AzureUtils.create_local_prediction_and_upload">[docs]</a>    <span class="k">def</span> <span class="nf">create_local_prediction_and_upload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                           <span class="n">local_json_file</span><span class="p">,</span>
                                           <span class="n">predictions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Store predictions (a .zip file) locally and upload</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">azure_save_file_name</span> <span class="o">=</span> <span class="n">local_json_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_root_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># TODO coverage</span>
            <span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">load_dft_args</span>
            <span class="n">console_args</span> <span class="o">=</span> <span class="n">load_dft_args</span><span class="p">()</span>
            <span class="n">output_dir</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">console_args</span><span class="p">,</span> <span class="s2">&quot;data_root_dir&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The path for saving the prediction .zip file is not specified, &quot;</span>
                  <span class="s2">&quot;setting to </span><span class="si">{}</span><span class="s2"> by default&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_dir</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_root_dir</span>
        <span class="n">local_archive_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">autohf</span><span class="o">.</span><span class="n">output_prediction</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span>
                                                           <span class="n">output_prediction_path</span><span class="o">=</span><span class="n">output_dir</span> <span class="o">+</span> <span class="s2">&quot;result/&quot;</span><span class="p">,</span>
                                                           <span class="n">output_zip_file_name</span><span class="o">=</span><span class="n">azure_save_file_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upload_local_file_to_azure</span><span class="p">(</span><span class="n">local_archive_path</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_after_earliest_time</span><span class="p">(</span><span class="n">this_blob</span><span class="p">,</span> <span class="n">earliest_time</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]):</span>
        <span class="c1"># TODO coverage</span>
        <span class="kn">import</span> <span class="nn">pytz</span>
        <span class="n">utc</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">UTC</span>
        <span class="k">if</span> <span class="n">this_blob</span><span class="o">.</span><span class="n">last_modified</span> <span class="o">&gt;=</span> <span class="n">utc</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="n">earliest_time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">earliest_time</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">earliest_time</span><span class="p">[</span><span class="mi">2</span><span class="p">])):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="AzureUtils.get_configblob_from_partial_jobid"><a class="viewcode-back" href="../../../../index.html#flaml.nlp.AzureUtils.get_configblob_from_partial_jobid">[docs]</a>    <span class="k">def</span> <span class="nf">get_configblob_from_partial_jobid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                          <span class="n">root_log_path</span><span class="p">,</span>
                                          <span class="n">partial_jobid</span><span class="p">,</span>
                                          <span class="n">earliest_time</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get all blobs whose jobid configs match the partial_jobid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">blob_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">container_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_azure_clients</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">container_client</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">each_blob</span> <span class="ow">in</span> <span class="n">container_client</span><span class="o">.</span><span class="n">list_blobs</span><span class="p">():</span>
                <span class="c1"># TODO coverage</span>
                <span class="k">if</span> <span class="n">each_blob</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">root_log_path</span><span class="p">):</span>
                    <span class="n">each_jobconfig</span> <span class="o">=</span> <span class="n">JobID</span><span class="o">.</span><span class="n">convert_blobname_to_jobid</span><span class="p">(</span><span class="n">each_blob</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">is_append</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">each_jobconfig</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">each_jobconfig</span><span class="o">.</span><span class="n">is_match</span><span class="p">(</span><span class="n">partial_jobid</span><span class="p">):</span>
                            <span class="n">is_append</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">earliest_time</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">AzureUtils</span><span class="o">.</span><span class="n">is_after_earliest_time</span><span class="p">(</span><span class="n">each_blob</span><span class="p">,</span> <span class="n">earliest_time</span><span class="p">):</span>
                            <span class="n">is_append</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="n">is_append</span><span class="p">:</span>
                            <span class="n">blob_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">each_jobconfig</span><span class="p">,</span> <span class="n">each_blob</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">blob_list</span></div>

<div class="viewcode-block" id="AzureUtils.get_config_and_score_from_partial_jobid"><a class="viewcode-back" href="../../../../index.html#flaml.nlp.AzureUtils.get_config_and_score_from_partial_jobid">[docs]</a>    <span class="k">def</span> <span class="nf">get_config_and_score_from_partial_jobid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                                <span class="n">root_log_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                                <span class="n">partial_jobid</span><span class="p">:</span> <span class="n">JobID</span><span class="p">,</span>
                                                <span class="n">earliest_time</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">           Extract the config and score list from a partial config id</span>

<span class="sd">           Args:</span>
<span class="sd">               root_log_path:</span>
<span class="sd">                   The root log path in azure blob storage, e.g., &quot;logs_seed/&quot;</span>

<span class="sd">               partial_jobid:</span>
<span class="sd">                   The partial jobid for matching the blob list</span>

<span class="sd">               earliest_time (optional):</span>
<span class="sd">                   The earliest starting time for any matched blob, for filtering out out-dated jobs,</span>
<span class="sd">                   format: (YYYY, MM, DD)</span>

<span class="sd">           Return:</span>
<span class="sd">               a ConfigScore list object which stores the config and scores list for each matched blob lists</span>

<span class="sd">       &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">root_log_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="s2">&quot;root_log_path must be of type str&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">partial_jobid</span><span class="p">,</span> <span class="n">JobID</span><span class="p">),</span> <span class="s2">&quot;partial_jobid must be of type JobID&quot;</span>
        <span class="k">if</span> <span class="n">earliest_time</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">earliest_time</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">),</span> <span class="s2">&quot;earliest_time must be a tuple of (YYYY, MM, DD)&quot;</span>

        <span class="n">matched_blob_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_configblob_from_partial_jobid</span><span class="p">(</span>
            <span class="n">root_log_path</span><span class="p">,</span>
            <span class="n">partial_jobid</span><span class="p">,</span>
            <span class="n">earliest_time</span><span class="o">=</span><span class="n">earliest_time</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config_and_score_from_matched_blob_list</span><span class="p">(</span><span class="n">matched_blob_list</span><span class="p">,</span>
                                                                <span class="n">earliest_time</span><span class="p">)</span></div>

<div class="viewcode-block" id="AzureUtils.get_config_and_score_from_matched_blob_list"><a class="viewcode-back" href="../../../../index.html#flaml.nlp.AzureUtils.get_config_and_score_from_matched_blob_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_config_and_score_from_matched_blob_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                                    <span class="n">matched_blob_list</span><span class="p">,</span>
                                                    <span class="n">earliest_time</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Extract the config and score list of one or multiple blobs</span>

<span class="sd">            Args:</span>
<span class="sd">                matched_blob_list:</span>
<span class="sd">                    matched blob list</span>

<span class="sd">            Return:</span>
<span class="sd">                a ConfigScore list object which stores the config and scores list for each matched blob lists</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">matched_config_score_lists</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">each_jobconfig</span><span class="p">,</span> <span class="n">each_blob</span><span class="p">)</span> <span class="ow">in</span> <span class="n">matched_blob_list</span><span class="p">:</span>
            <span class="c1"># TODO coverage</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">download_azure_blob</span><span class="p">(</span><span class="n">each_blob</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">data_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">each_blob</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">))</span>
            <span class="n">each_config_and_score_list</span> <span class="o">=</span> <span class="n">ConfigScoreList</span><span class="p">(</span>
                <span class="n">jobid_config</span><span class="o">=</span><span class="n">each_jobconfig</span><span class="p">,</span>
                <span class="n">blob_file</span><span class="o">=</span><span class="n">each_blob</span><span class="p">,</span>
                <span class="n">config_score_list</span><span class="o">=</span><span class="p">[</span><span class="n">ConfigScore</span><span class="p">(</span><span class="o">**</span><span class="n">each_dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">each_dict</span> <span class="ow">in</span> <span class="n">data_json</span><span class="p">[</span><span class="s1">&#39;val_log&#39;</span><span class="p">]])</span>
            <span class="n">matched_config_score_lists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">each_config_and_score_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">matched_config_score_lists</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020-2021, FLAML Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>